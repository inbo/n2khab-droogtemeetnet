---
title: "Watina export voor Menyanthes"
author: "Jan Wouters"
date: '`r paste("Versie",lubridate::now())`'
output: 
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
source("G:/Mijn Drive/PRJ_GRONDWATERGEGEVENS/Tijdreeksanalyse/VoerVoorMenyanthes.R")
#source("C:/R/Projecten/Watina/src/invoerMenyanthes_gauge.R")
library(git2rdata)
library(tidyverse)
library(ggplot2)
library(knitr)
#opgaven van een gebiedscode
localpath_output <- "./data/local/tijdreeksen/importbestanden_menyanthes/"

opts_chunk$set(echo = TRUE,
  cache = FALSE,
  cache.path = "cache/"
)
```

# Inleiding

Dit document demonstreert het gebruik van twee functies. 

1. Een functie waarmee je de Watina-databank rechtstreeks kan bevragen voor peilgegevens. Zowel grondwaterpeilen als oppervlaktewaterpeilen kunnen opgevraagd worden.

1. Een functie waarmee je peilgegevens van Watina kan opvragen en die deze transformeert in het hydromonitor-formaat. Bestanden in dit formaat kunnen ingelezen worden in Menyanthes.

Verder worden ook de verkregen data geïnspecteerd.

# Gebruik van de functies

## Functie voor het inlezen grond- of oppervlaktewaterdata

Je hebt de keuze tussen ophalen van alle grond- of oppervlaktewaterpeilen van een gebied
of van de peilen voor een opgegeven lijst van meetpunten (watinacode van **_7_** karakters).
We geven hier een voorbeeld voor het opvragen van grondwaterdata van een gebied. Dit gebeurt met de opgave van de `gebiedscode` (3 karakters). 

```{r inlezen-grondwaterdata-gebied}
gebiedscode <- "SIL"
peilen <- import_watina_peilmetingen(gebiedscode, ookdefinities = TRUE, oppervlaktewater = FALSE)
```

## Functie voor het inlezen grond- of oppervlaktewaterdata en deze omzetten in het hydromonitor-formaat
Hier een voorbeeld voor de aanmaak van een hydromonitor-bestand voor een gebied.
```{r inlezen-hydromonitor}
gebiedscode <- "SIL"
peilen_export <- hydromonitor_peilmeting_csv_formaat(gebiedscode, 
                                              ookdefinities = TRUE,
                                              oppervlaktewater = FALSE
                                              )
```

# Nazicht van de data
```{r datavoorbereiding, echo=FALSE}
# backup
peilen.bu <- peilen
peilen <- peilen.bu

#veldnamen aanpassen
peilen <- peilen %>%
  rename(meetpunt = Name,
         filternr = FilterNo,
         dag = DateTime,
         logger_head = LoggerHead,
         manual_head = ManualHead)

# conversie veld DateTime (tekst) naar een datum-veld, meetpunt naar een factor
peilen <- peilen %>% 
  mutate(dag = lubridate::dmy_hm(dag),
         meetpunt =  factor(meetpunt)) %>% 
  distinct(meetpunt, filternr, dag, logger_head, manual_head)
```
## Overzichtstabel

```{r overzichtstabel-basis, echo=FALSE}
kable(summary(peilen), caption = "overzichtstabel - basis")

```
Uit het overzicht blijkt dat de velden filternr en logger_head kunnen verwijderd worden.
```{r overzichtstabel, echo=FALSE}
peilen <- peilen %>% 
  select(-filternr, -logger_head)

peilen.overzicht <- peilen %>% 
  group_by(meetpunt) %>% 
  summarise(aantal_metingen = n(),
            head.min = min(manual_head),
            head.q10 = quantile(manual_head,0.10),            
            head.q25 = quantile(manual_head,0.25),
            head.median = median(manual_head),
            head.mean = mean(manual_head),
            head.q75 = quantile(manual_head, 0.75),
            head.q90 = quantile(manual_head,0.90),
            head.max = max(manual_head)
            ) %>% 
  kable(caption = "overzichtstabel")
peilen.overzicht
```

## grafiek met een tijdreeks van één meetpunt
 We tonen hier de tijdreeks voor één meetpunt, nl. `r keuze_meetpunt <- "SILP001"; keuze_meetpunt`

```{r grafiek-basis}

peilen.meetpunt <- peilen %>% 
  filter(meetpunt == keuze_meetpunt)
peil.grafiek <- ggplot(peilen.meetpunt, aes(x = dag, y = manual_head)) + 
  geom_line()
peil.grafiek
```
## boxplot van alle meetpunten van een gebied
Boxplots geven een andere kijk op de data.

```{r boxplot-gebied, echo=FALSE, fig.cap="boxplot"}
peilen.boxplot <- ggplot(peilen, aes(x = meetpunt, y = manual_head))+
  geom_boxplot()
peilen.boxplot
```
Deze boxplots laten hele grote verschillen zien, omdat er voor sommige meetpunten de meetwaarden tov maaiveld werden uitgedrukt (door gebrek aan een positiebepaling) en voor andere meetpunten ze in mTAW zijn uitgedrukt. 
Het is dus nodig om hiermee rekening te houden en twee verschillende boxplots te maken.

Eerst een boxplot voor de meetpunten met meetwaarden uitgedrukt t.o.v. het maaiveld.

```{r boxplot-gebied-mv, echo=FALSE, fig.cap="boxplot maaiveld"}
peilen.boxplot.mv <- ggplot(peilen %>% 
                              filter(stringr::str_sub(as.character(meetpunt), 7,7) %in% c("1","5","6")
                                     ) , aes(x = meetpunt, y = manual_head))+
  geom_boxplot() + labs(y = "grondwaterpeil tov maaiveld (m)")
peilen.boxplot.mv



```
En dan een boxplot voor de andere meetpunten, met meetwaarden uitgedrukt in mTAW.

```{r boxplot-gebied-taw, echo=FALSE, fig.cap="boxplot mTAW"}

peilen.boxplot.taw <- ggplot(peilen %>% 
                              filter(stringr::str_sub(as.character(meetpunt), 7,7) %in% c("2","3","4")
                              ) , aes(x = meetpunt, y = manual_head))+
  geom_boxplot() + labs(y = "grondwaterpeil (mTAW)")
peilen.boxplot.taw
```

Deze data kunnen nu weggeschreven worden.

```{r exportdata, include=FALSE}
readr::write_delim(as.data.frame(peilen_export), 
             paste0(localpath_output, "Hydromonitor_peilmetingen_",tolower(gebiedscode),".csv"), 
             col_names = FALSE, quote_escape = FALSE, delim = "µ", na = "")
```

